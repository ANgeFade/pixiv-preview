# ğŸ”§ æµ‹è¯•å’Œè°ƒè¯•æŒ‡å—

## âš ï¸ é‡è¦ï¼šå·²ä¿®å¤é˜²ç›—é“¾é—®é¢˜

åˆšæ‰ä¿®å¤äº†æ ¸å¿ƒé—®é¢˜ï¼šæ·»åŠ äº† **declarativeNetRequest è§„åˆ™**ï¼Œç°åœ¨æ‰€æœ‰å¯¹ `i.pximg.net` çš„è¯·æ±‚éƒ½ä¼šè‡ªåŠ¨å¸¦ä¸Š `Referer: https://www.pixiv.net/`

---

## ğŸ“‹ é‡æ–°å®‰è£…æ­¥éª¤

### 1. å¸è½½æ—§ç‰ˆæœ¬
1. æ‰“å¼€ `chrome://extensions/`
2. æ‰¾åˆ°"Pixiv åŸå›¾é¢„è§ˆå¢å¼º"
3. ç‚¹å‡»"ç§»é™¤"æŒ‰é’®

### 2. é‡æ–°åŠ è½½æ–°ç‰ˆæœ¬
1. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
2. é€‰æ‹© `f:\code_program\pixiv-preview\extension`
3. ç¡®è®¤åŠ è½½æˆåŠŸ

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤1ï¼šéªŒè¯æ‰©å±•åŠ è½½
1. æ‰“å¼€ `chrome://extensions/`
2. æ‰¾åˆ°"Pixiv åŸå›¾é¢„è§ˆå¢å¼º"
3. æ£€æŸ¥çŠ¶æ€ï¼š
   - âœ… å·²å¯ç”¨
   - âœ… æ— é”™è¯¯æç¤º
   - âœ… æ˜¾ç¤ºç‰ˆæœ¬ 1.0.0

### æ­¥éª¤2ï¼šæ£€æŸ¥åå°è„šæœ¬
1. åœ¨æ‰©å±•å¡ç‰‡ä¸Šç‚¹å‡»"Service Worker"é“¾æ¥
2. ä¼šæ‰“å¼€ä¸€ä¸ªè°ƒè¯•çª—å£
3. æŸ¥çœ‹Consoleï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ```
   Pixiv åŸå›¾é¢„è§ˆå¢å¼ºæ‰©å±•å·²å®‰è£…
   è¯·æ±‚å¤´ä¿®æ”¹è§„åˆ™å·²è®¾ç½®
   ```

### æ­¥éª¤3ï¼šæµ‹è¯•Pixivé¡µé¢
1. è®¿é—® https://www.pixiv.net/
2. æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
3. åˆ‡æ¢åˆ° Console æ ‡ç­¾
4. åº”è¯¥çœ‹åˆ°ï¼š
   ```
   ğŸ¨ Pixiv åŸå›¾é¢„è§ˆå¢å¼ºæ‰©å±•å·²åŠ è½½
   ğŸ“Œ æ‰¾åˆ°ä½œå“: ID=xxxxx, Page=0
   ...
   âœ¨ Pixiv åŸå›¾é¢„è§ˆå¢å¼ºæ‰©å±•å°±ç»ªï¼
   ```

### æ­¥éª¤4ï¼šæµ‹è¯•é¢„è§ˆåŠŸèƒ½
1. åœ¨Pixivé¦–é¡µæ»šåŠ¨åˆ°ä½œå“åˆ—è¡¨
2. é¼ æ ‡æ‚¬åœåœ¨ä»»æ„ç¼©ç•¥å›¾ä¸Š
3. ç­‰å¾…300ms
4. è§‚å¯Ÿå³ä¾§æ˜¯å¦å‡ºç°é¢„è§ˆæ¡†

### æ­¥éª¤5ï¼šéªŒè¯è¯·æ±‚å¤´
1. å¼€å‘è€…å·¥å…· â†’ Network æ ‡ç­¾é¡µ
2. è¿‡æ»¤é€‰æ‹© "Img"
3. é¼ æ ‡æ‚¬åœè§¦å‘é¢„è§ˆ
4. æ‰¾åˆ° `i.pximg.net` çš„è¯·æ±‚
5. æŸ¥çœ‹ Request Headers
6. **å…³é”®æ£€æŸ¥**ï¼šåº”è¯¥æœ‰ `Referer: https://www.pixiv.net/`
7. **çŠ¶æ€ç **ï¼šåº”è¯¥æ˜¯ `200 OK`ï¼Œä¸å†æ˜¯ `403 Forbidden`

---

## ğŸ› é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šæ‰©å±•æ— æ³•åŠ è½½
**ç—‡çŠ¶**ï¼šç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"åæŠ¥é”™

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `manifest.json` æ ¼å¼æ˜¯å¦æ­£ç¡®
2. ç¡®ä¿æ‰€æœ‰æ–‡ä»¶éƒ½å­˜åœ¨ï¼š
   ```
   extension/
   â”œâ”€â”€ manifest.json âœ“
   â”œâ”€â”€ background.js âœ“
   â”œâ”€â”€ content.js âœ“
   â”œâ”€â”€ styles.css âœ“
   â”œâ”€â”€ popup.html âœ“
   â”œâ”€â”€ popup.js âœ“
   â”œâ”€â”€ rules.json âœ“ (æ–°å¢)
   â””â”€â”€ icons/
       â”œâ”€â”€ icon16.png âœ“
       â”œâ”€â”€ icon48.png âœ“
       â””â”€â”€ icon128.png âœ“
   ```

### é—®é¢˜2ï¼šä¾æ—§è¿”å›403
**ç—‡çŠ¶**ï¼šNetworkä¸­çœ‹åˆ°è¯·æ±‚è¿˜æ˜¯403 Forbidden

**å¯èƒ½åŸå› **ï¼š
1. æ‰©å±•æ²¡æœ‰æ­£ç¡®é‡æ–°åŠ è½½
2. è§„åˆ™æ²¡æœ‰ç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ­¥éª¤1ï¼šå®Œå…¨å¸è½½æ‰©å±•
chrome://extensions/ â†’ ç§»é™¤æ‰©å±•

# æ­¥éª¤2ï¼šé‡å¯æµè§ˆå™¨
å…³é—­æ‰€æœ‰Chromeçª—å£ï¼Œé‡æ–°æ‰“å¼€

# æ­¥éª¤3ï¼šé‡æ–°åŠ è½½æ‰©å±•
chrome://extensions/ â†’ åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº

# æ­¥éª¤4ï¼šæ£€æŸ¥è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆ
åœ¨æ‰©å±•é¡µé¢ç‚¹å‡»"service worker" â†’ æŸ¥çœ‹Console
```

### é—®é¢˜3ï¼šçœ‹ä¸åˆ°é¢„è§ˆæ¡†
**ç—‡çŠ¶**ï¼šé¼ æ ‡æ‚¬åœæ²¡æœ‰ååº”

**è°ƒè¯•æ­¥éª¤**ï¼š
1. **æ£€æŸ¥Consoleæ—¥å¿—**
   ```javascript
   // åº”è¯¥çœ‹åˆ°è¿™äº›æ—¥å¿—
   ğŸ¨ Pixiv åŸå›¾é¢„è§ˆå¢å¼ºæ‰©å±•å·²åŠ è½½
   ğŸ“Œ æ‰¾åˆ°ä½œå“: ID=xxxxx
   ğŸ” å°è¯•æ ¼å¼: png
   ```

2. **æ‰‹åŠ¨æµ‹è¯•**
   åœ¨Consoleè¾“å…¥ï¼š
   ```javascript
   // æŸ¥çœ‹æ‰©å±•æ˜¯å¦æ³¨å…¥
   document.querySelector('.pixiv-preview-container')
   
   // æŸ¥çœ‹å›¾ç‰‡æ˜¯å¦è¢«å¤„ç†
   document.querySelectorAll('[data-pixiv-processed]').length
   ```

3. **æ£€æŸ¥å›¾ç‰‡è¯†åˆ«**
   ```javascript
   // æŸ¥çœ‹æ˜¯å¦èƒ½è¯†åˆ«åˆ°ä½œå“ID
   const imgs = document.querySelectorAll('img[src*="pximg.net"]');
   imgs.forEach(img => {
       console.log('ä½œå“ID:', img.dataset.artworkId);
       console.log('é¡µç :', img.dataset.page);
   });
   ```

### é—®é¢˜4ï¼šè§„åˆ™ä¸ç”Ÿæ•ˆ
**éªŒè¯è§„åˆ™**ï¼š
```javascript
// åœ¨Service Worker Consoleä¸­æ‰§è¡Œ
chrome.declarativeNetRequest.getDynamicRules().then(rules => {
    console.log('åŠ¨æ€è§„åˆ™:', rules);
});

chrome.declarativeNetRequest.getEnabledRulesets().then(rulesets => {
    console.log('å¯ç”¨çš„è§„åˆ™é›†:', rulesets);
});
```

---

## ğŸ“Š é¢„æœŸç»“æœ

### âœ… æˆåŠŸæ ‡å¿—

| æ£€æŸ¥é¡¹ | é¢„æœŸç»“æœ |
|--------|---------|
| æ‰©å±•åŠ è½½ | æ— é”™è¯¯ï¼Œæ˜¾ç¤ºå·²å¯ç”¨ |
| Consoleæ—¥å¿— | æ˜¾ç¤º"æ‰©å±•å·²åŠ è½½"ç­‰ä¿¡æ¯ |
| å›¾ç‰‡è¯†åˆ« | æ‰¾åˆ°ä½œå“IDå’Œé¡µç  |
| è¯·æ±‚å¤´ | åŒ…å« `Referer: https://www.pixiv.net/` |
| å“åº”çŠ¶æ€ | 200 OKï¼ˆä¸æ˜¯403ï¼‰ |
| é¢„è§ˆæ˜¾ç¤º | æ‚¬åœåå‡ºç°é¢„è§ˆæ¡† |
| å›¾ç‰‡åŠ è½½ | åŸå›¾æˆåŠŸæ˜¾ç¤º |

### âŒ å¤±è´¥æ ‡å¿—

| ç—‡çŠ¶ | å¯èƒ½åŸå›  |
|------|---------|
| 403 Forbidden | è§„åˆ™æœªç”Ÿæ•ˆï¼ŒRefererç¼ºå¤± |
| Consoleæ— æ—¥å¿— | content.js æœªæ³¨å…¥ |
| æ— æ³•è¯†åˆ«ä½œå“ID | é¡µé¢ç»“æ„å˜åŒ– |
| é¢„è§ˆæ¡†ä¸æ˜¾ç¤º | CSSæœªåŠ è½½æˆ–äº‹ä»¶æœªç»‘å®š |

---

## ğŸ” è°ƒè¯•å‘½ä»¤é€ŸæŸ¥

### Chromeæ‰©å±•é¡µé¢
```
chrome://extensions/
```

### æŸ¥çœ‹Service Workeræ—¥å¿—
æ‰©å±•å¡ç‰‡ â†’ ç‚¹å‡» "service worker" é“¾æ¥

### æŸ¥çœ‹Content Scriptæ—¥å¿—
Pixivé¡µé¢ â†’ F12 â†’ Console

### æŸ¥çœ‹ç½‘ç»œè¯·æ±‚
F12 â†’ Network â†’ è¿‡æ»¤ "pximg.net"

### æ¸…é™¤ç¼“å­˜
æ‰©å±•å›¾æ ‡ â†’ æ¸…é™¤ç¼“å­˜

---

## ğŸ“ å…³é”®ä¿®æ”¹è¯´æ˜

### manifest.json æ–°å¢ï¼š
```json
"declarative_net_request": {
  "rule_resources": [
    {
      "id": "pixiv_referer_rules",
      "enabled": true,
      "path": "rules.json"
    }
  ]
}
```

### æ–°æ–‡ä»¶ï¼šrules.json
```json
[
  {
    "id": 1,
    "priority": 1,
    "action": {
      "type": "modifyHeaders",
      "requestHeaders": [
        {
          "header": "Referer",
          "operation": "set",
          "value": "https://www.pixiv.net/"
        }
      ]
    },
    "condition": {
      "urlFilter": "*://i.pximg.net/*",
      "resourceTypes": ["xmlhttprequest", "image"]
    }
  }
]
```

è¿™ä¸ªè§„åˆ™ä¼šè‡ªåŠ¨ä¸ºæ‰€æœ‰ `i.pximg.net` çš„è¯·æ±‚æ·»åŠ  Referer å¤´ï¼

---

**ç°åœ¨é‡æ–°åŠ è½½æ‰©å±•ï¼Œåº”è¯¥å°±å¯ä»¥æ­£å¸¸è·å–åŸå›¾äº†ï¼** ğŸ‰
